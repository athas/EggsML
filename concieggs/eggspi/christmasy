#!/bin/sh

# VIGTIGT: Niels har _forbud_ mod at ændre i dette program.

prog=$(cat <<"EOF"
function frobword_inner(s) {
  fst = substr(s,1,1)
  prefix = toupper(s) == s ? "JULE-" : toupper(fst) == fst ? "Jule-" : "jule-"
  if (length(s) > 3 && !festive) {
    return prefix s
  } else if (length(s) > 3 && rand() > 0.1) {
    return frobword_inner(prefix s)
  } else {
    return s
  }
}
function frobword(s) {
  if (match(s, "[jJ]ul") != 1 && rand() > 0.75) {
    return frobword_inner(s)
  } else {
    return s
  }
}
function frob(s) {
  match(s, "[a-zA-ZæøåÆØÅ]+")
  if (RSTART == 0) {
    return s
  } else {
    wstart=RSTART
    wlength=RLENGTH

    # If an URL overlaps with the next word, skip past the URL
    # else, frob the word!

    match(s, "https?://[^ ]+")
    if (RSTART > 0 && RSTART <= wstart+wlength) {
        # Overlap (freeze, don't frob)
        pre=substr(s,1,wstart+wlength)
        post=substr(s,wstart+wlength+1,length(s))
        return pre frob(post)
    } else {
        # No overlap (c'mon, let's make it frob)
        pre=substr(s,1,wstart-1)
        post=substr(s,wstart+wlength,length(s))
        return pre frobword(substr(s,wstart,wlength)) frob(post)
    }
  }
}
{
festive=0
srand()
print frob($0)
fflush(); 
}
EOF
)

awk -- "$prog" | sed "s/træ/juletræ-/g" | sed "s/Træ/Juletræ-/g"
