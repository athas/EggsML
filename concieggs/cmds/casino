#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# CONCIEGGS CASINO - Spil dine concieggs-poletter v칝k!
# Kom og spil! Men pas p친 - concieggs husker hvis du er slem.

import subprocess
import sys
import os
import json
from datetime import datetime, timedelta

def get_user():
    # Hvem er du egentlig?
    return os.getenv("EGGS_USER", "").strip()

def get_annoyance():
    # Hvor irriteret er concieggs p친 brugeren? Jo h칮jere tal, jo mere sur.
    user = get_user()
    try:
        result = subprocess.check_output(["annoyanceAt", user], stderr=subprocess.DEVNULL)
        return int(result.decode().strip())
    except:
        return 0

def get_casino_data():
    # Henter casinoets store bog med poletter og hvem der har v칝ret her
    try:
        db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
        with open(f"{db_dir}/store/casino", "r") as f:
            return json.loads(f.read())
    except:
        return {"tokens": {}, "last_claim": {}}

def set_casino_data(data):
    # Gemmer tingene v칝k s친 vi kan huske det n칝ste gang
    json_str = json.dumps(data, ensure_ascii=False)
    db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
    os.makedirs(f"{db_dir}/store", exist_ok=True)
    with open(f"{db_dir}/store/casino", "w") as f:
        f.write(json_str)

def get_tokens(user=None):
    # T칝ller hvor mange poletter nogen har. Hvis ingen navn gives, s친 den nuv칝rende bruger.
    if user is None:
        user = get_user()
    data = get_casino_data()
    return data.get("tokens", {}).get(user, 0)

def set_tokens(user, amount):
    # S칝tter antallet af poletter for en bruger
    data = get_casino_data()
    if "tokens" not in data:
        data["tokens"] = {}
    data["tokens"][user] = amount
    set_casino_data(data)

def can_claim_today():
    # Kan brugeren hente flere poletter i dag? Man m친 kun hente 칠n gang om dagen!
    user = get_user()
    data = get_casino_data()
    last_claim = data.get("last_claim", {}).get(user)
    
    if not last_claim:
        return True
    
    today = datetime.now().date().isoformat()
    return last_claim != today

def claim_tokens():
    # Her kan man hente sine daglige poletter! Men kun 칠n gang om dagen.
    user = get_user()
    
    if not can_claim_today():
        print(f"Du har allerede hentet dine poletter i dag, {user}!")
        print(f"Du har {get_tokens()} poletter.")
        return
    
    # Giv 100 poletter, men tr칝k fra hvis concieggs er irriteret
    annoyance = get_annoyance()
    base_tokens = 100
    tokens = max(10, base_tokens - annoyance * 5)
    
    current = get_tokens()
    new_total = current + tokens
    
    data = get_casino_data()
    if "tokens" not in data:
        data["tokens"] = {}
    if "last_claim" not in data:
        data["last_claim"] = {}
    
    data["tokens"][user] = new_total
    data["last_claim"][user] = datetime.now().date().isoformat()
    set_casino_data(data)
    
    # Concieggs er m친ske lidt sur...
    if annoyance > 5:
        print(f"N친 {user}... jeg kan se du ikke har opf칮rt dig p칝nt.")
        print(f"Du f친r kun {tokens} poletter i dag.")
    elif annoyance > 0:
        print(f"Okay {user}, her er {tokens} poletter til dig.")
    else:
        print(f"Velkommen til casinoet, {user}! Her er {tokens} poletter!")
    
    print(f"Du har nu {new_total} poletter i alt.")

def show_balance():
    # Vis hvor mange poletter brugeren har
    user = get_user()
    tokens = get_tokens()
    print(f"{user}: Du har {tokens} poletter.")
    
    if can_claim_today():
        print("Du kan hente flere poletter i dag! Brug: casino hent")

def help_text():
    # Hj칝lpetekst til casinoet
    print("""游꿣游꿣 VELKOMMEN TIL CONCIEGGS CASINO 游꿣游꿣

Kommandoer:
  casino hent       - Hent dine daglige poletter
  casino balance    - Se hvor mange poletter du har
  casino roulette   - Spil roulette!
  casino hj칝lp      - Vis denne hj칝lp

Husk: Du kan tilmelde dig https://www.spillemyndigheden.dk/rofus
hvis du vil undg친 at komme til at spille dine penge v칝k.
P친 nuv칝rende tidspunkt er en lignende ordning for concieggs-poletterne
dog ikke planlagt.""")

def main():
    # Hovedfunktion - her starter det hele
    user = get_user()
    if not user:
        print("Noget gik galt...")
        return
    
    args = sys.argv[1:]
    
    if not args or args[0] in ["hj칝lp", "help"]:
        help_text()
    elif args[0] in ["hent", "claim"]:
        claim_tokens()
    elif args[0] in ["balance", "poletter", "tokens"]:
        show_balance()
    elif args[0] == "roulette":
        # Sender videre til roulette kommandoen
        script_dir = os.path.dirname(os.path.abspath(__file__))
        roulette_path = os.path.join(script_dir, "roulette")
        os.execv(roulette_path, ["roulette"] + args[1:])
    else:
        help_text()

if __name__ == "__main__":
    main()
