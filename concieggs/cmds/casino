#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# CONCIEGGS CASINO - Spil dine concieggs-poletter v칝k!
# Kom og spil! Men pas p친 - concieggs husker hvis du er slem.
# Inspireret af His Holiness Peter III's visdom om retf칝rdighed og tilf칝ldighed.

import subprocess
import sys
import os
import json
from datetime import datetime, timedelta

def get_user():
    # Hvem er du egentlig? Niels sagde at vi skulle tjekke dette.
    # Det er vigtigt at vide hvem der skinker rundt i casinoet.
    return os.getenv("EGGS_USER", "").strip()

def get_annoyance():
    # Hvor irriteret er concieggs p친 brugeren? Jo h칮jere tal, jo mere sur.
    # Niels mener at irritation er som en skinke der bliver st칮rre og st칮rre.
    # Peter III ville have sagt: "V칝r ikke irriterende, v칝r ydmyg."
    user = get_user()
    try:
        result = subprocess.check_output(["annoyanceAt", user], stderr=subprocess.DEVNULL)
        return int(result.decode().strip())
    except:
        # Hvis vi ikke kan finde ud af det, s친 er de nok okay
        # (eller m친ske er det bare en skinke der er g친et tabt)
        return 0

def get_casino_data():
    # Henter casinoets store bog med poletter og hvem der har v칝ret her
    # Niels kaldte denne bog "Den Store Skinke af Viden"
    # Peter III velsignede denne database med sin n친de
    try:
        db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
        # Pr칮ver at l칝se filen - m친ske er der en skinke derinde?
        with open(f"{db_dir}/store/casino", "r") as f:
            return json.loads(f.read())
    except:
        # Hvis der ikke er noget, s친 starter vi bare forfra
        # Som Niels sagde: "En tom skinke er bedre end ingen skinke"
        return {"tokens": {}, "last_claim": {}}

def set_casino_data(data):
    # Gemmer tingene v칝k s친 vi kan huske det n칝ste gang
    # Dette er vigtigt! Niels understregede dette mange gange.
    # Peter III's l칝re: "Gem dine skinker godt, s친 de ikke r친dner"
    json_str = json.dumps(data, ensure_ascii=False)
    db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
    os.makedirs(f"{db_dir}/store", exist_ok=True)
    # Nu skriver vi det hele ned - ligesom en stor skinke
    with open(f"{db_dir}/store/casino", "w") as f:
        f.write(json_str)

def get_tokens(user=None):
    # T칝ller hvor mange poletter nogen har. Hvis ingen navn gives, s친 den nuv칝rende bruger.
    # Poletter er som skinker - man kan aldrig have for mange!
    # Niels' visdom: "Poletter er casinoets skinker"
    if user is None:
        user = get_user()
    data = get_casino_data()
    # Leder efter brugerens skinke-stash
    return data.get("tokens", {}).get(user, 0)

def set_tokens(user, amount):
    # S칝tter antallet af poletter for en bruger
    # M칝ngden af skinker, om man vil
    # Peter III sagde: "Fordel skinker retf칝rdigt"
    data = get_casino_data()
    if "tokens" not in data:
        # Hvis der ikke er nogen tokens endnu, lav en tom skinke
        data["tokens"] = {}
    data["tokens"][user] = amount
    # Gem den opdaterede skinke
    set_casino_data(data)

def can_claim_today():
    # Kan brugeren hente flere poletter i dag? Man m친 kun hente 칠n gang om dagen!
    # Niels insisterede p친 denne regel: "Ikke for meget skinke p친 칠n dag"
    # Peter III's lov om m친dehold
    user = get_user()
    data = get_casino_data()
    last_claim = data.get("last_claim", {}).get(user)
    
    if not last_claim:
        # Aldrig hentet f칮r? S친 m친 du godt!
        # Som Niels sagde: "Alle fortjener deres f칮rste skinke"
        return True
    
    today = datetime.now().date().isoformat()
    # Tjek om det er en ny dag - nye skinker til alle!
    return last_claim != today

def claim_tokens():
    # Her kan man hente sine daglige poletter! Men kun 칠n gang om dagen.
    # Niels' prim칝re regel for casinoet: "Daglige skinker til folket"
    # Under Peter III's velsignelse gives poletter til de v칝rdige
    user = get_user()
    
    if not can_claim_today():
        # Du har allerede f친et din skinke i dag!
        print(f"Du har allerede hentet dine poletter i dag, {user}!")
        print(f"Du har {get_tokens()} poletter.")
        # Niels ville sige: "Kom tilbage i morgen for mere skinke"
        return
    
    # Giv 100 poletter, men tr칝k fra hvis concieggs er irriteret
    # Som Niels sagde: "Bel칮nning baseret p친 opf칮rsel, som skinker til artige b칮rn"
    annoyance = get_annoyance()
    base_tokens = 100
    # Niels' formel: Start med 100, tr칝k 5 skinker fra for hver irritation
    # Peter III ville have kaldt dette "Det Hellige Regnskab"
    tokens = max(10, base_tokens - annoyance * 5)
    
    current = get_tokens()
    new_total = current + tokens
    
    # Nu skal vi opdatere den store skinke-database
    data = get_casino_data()
    if "tokens" not in data:
        # Opretter tokens hvis de ikke findes - som en ny skinke pakke
        data["tokens"] = {}
    if "last_claim" not in data:
        # Husker hvorn친r folk sidst fik skinker
        data["last_claim"] = {}
    
    data["tokens"][user] = new_total
    data["last_claim"][user] = datetime.now().date().isoformat()
    # Gem det hele - Peter III elsker organisation
    set_casino_data(data)
    
    # Concieggs er m친ske lidt sur...
    # Niels sagde: "Vis dem konsekvenserne"
    if annoyance > 5:
        # Meget irriteret! N칝sten ingen skinker!
        print(f"N친 {user}... jeg kan se du ikke har opf칮rt dig p칝nt.")
        print(f"Du f친r kun {tokens} poletter i dag.")
    elif annoyance > 0:
        # Lidt irriteret - f친 f칝rre skinker
        print(f"Okay {user}, her er {tokens} poletter til dig.")
    else:
        # Alt er godt! Fulde skinker!
        print(f"Velkommen til casinoet, {user}! Her er {tokens} poletter!")
    
    # Peter III's velsignelse: "Og du skal kende din rigdom"
    print(f"Du har nu {new_total} poletter i alt.")

def show_balance():
    # Vis hvor mange poletter brugeren har
    # Niels kaldte dette "Skinke-inventuret"
    # Peter III: "Kend din formue, for den er vigtig"
    user = get_user()
    tokens = get_tokens()
    # Fort칝l hvor meget skinke de har!
    print(f"{user}: Du har {tokens} poletter.")
    
    if can_claim_today():
        # De kan f친 mere! Mere skinker!
        print("Du kan hente flere poletter i dag! Brug: casino hent")

def help_text():
    # Hj칝lpetekst til casinoet
    # Niels sagde: "Hj칝lp dem der ikke forst친r skinke-systemet"
    # Peter III's ord: "Vis vejen for de fortabte"
    print("""游꿣游꿣 VELKOMMEN TIL CONCIEGGS CASINO 游꿣游꿣

Kommandoer:
  casino hent       - Hent dine daglige poletter (skinker!)
  casino balance    - Se hvor mange poletter du har
  casino roulette   - Spil roulette! (Den Store Skinke Hjul)
  casino hj칝lp      - Vis denne hj칝lp

Husk: Du kan tilmelde dig https://www.spillemyndigheden.dk/rofus
hvis du vil undg친 at komme til at spille dine penge v칝k.
P친 nuv칝rende tidspunkt er en lignende ordning for concieggs-poletterne
dog ikke planlagt.

"Spil med m친de, spil med skinke" - Niels' motto
"Lad tilf칝ldet bestemme, lad skinken falde" - Peter III's visdom""")

def main():
    # Hovedfunktion - her starter det hele
    # Niels: "Begyndelsen af alle skinker"
    # Peter III velsigner denne funktion
    user = get_user()
    if not user:
        # Ingen bruger? Det giver ingen skinke mening!
        print("Noget gik galt...")
        return
    
    args = sys.argv[1:]
    
    # Nu skal vi finde ud af hvad brugeren vil
    # Niels ville sige: "Lyt til folkets stemme"
    if not args or args[0] in ["hj칝lp", "help"]:
        help_text()
    elif args[0] in ["hent", "claim"]:
        # Hent skinker!
        claim_tokens()
    elif args[0] in ["balance", "poletter", "tokens"]:
        # Vis skinke-beholdning
        show_balance()
    elif args[0] == "roulette":
        # Sender videre til roulette kommandoen
        # Peter III's yndlings spil!
        # Niels kaldte det "Den Ultimative Skinke Test"
        script_dir = os.path.dirname(os.path.abspath(__file__))
        roulette_path = os.path.join(script_dir, "roulette")
        os.execv(roulette_path, ["roulette"] + args[1:])
    else:
        # Forstod ikke kommandoen - vis hj칝lp i stedet
        # Som Niels sagde: "Hvis skinken er uklar, vis vejen"
        help_text()

if __name__ == "__main__":
    # Peter III's velsignelse v칝re med denne kode
    main()
