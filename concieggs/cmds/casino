#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# CONCIEGGS CASINO - Spil dine concieggs-poletter v칝k!
# Kom og spil! Men pas p친 - concieggs husker hvis du er slem.
# Inspireret af ham fra Dahlg친rd's Tivoli og hans visdom om casinospil og tilf칝ldighed.
# Niels tog os med derhen engang - det var en oplevelse!

import subprocess
import sys
import os
import json
from datetime import datetime, timedelta

def get_user():
    # Hvem er du egentlig? Niels sagde at vi skulle tjekke dette.
    # Det er vigtigt at vide hvem der skinker rundt i casinoet.
    # Ham fra Dahlg친rd's Tivoli kendte altid sine g칝ster
    return os.getenv("EGGS_USER", "").strip()

def get_annoyance():
    # Hvor irriteret er concieggs p친 brugeren? Jo h칮jere tal, jo mere sur.
    # Niels mener at irritation er som en skinke der bliver st칮rre og st칮rre.
    # Ham fra Dahlg친rd's Tivoli ville have sagt: "V칝r ikke irriterende, v칝r ydmyg."
    # Det er vigtigt at v칝re h칮flig i casinoet - ligesom i Tivoli!
    user = get_user()
    try:
        # Pr칮ver at kalde annoyanceAt kommandoen
        # Hvis den fejler, s친 antager vi bare at de er okay
        result = subprocess.check_output(["annoyanceAt", user], stderr=subprocess.DEVNULL)
        return int(result.decode().strip())
    except:
        # Hvis vi ikke kan finde ud af det, s친 er de nok okay
        # (eller m친ske er det bare en skinke der er g친et tabt)
        # Niels sagde: "I tvivl, s친 v칝r gavmild"
        return 0

def get_casino_data():
    # Henter casinoets store bog med poletter og hvem der har v칝ret her
    # Niels kaldte denne bog "Den Store Skinke af Viden"
    # Ham fra Dahlg친rd's Tivoli havde ogs친 s친dan en bog - meget gammel og slidt
    # Men den virkede! Ligesom vores database virker!
    try:
        db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
        # Pr칮ver at l칝se filen - m친ske er der en skinke derinde?
        # Ligesom n친r man 친bner k칮leskabet og h친ber p친 at finde skinke
        with open(f"{db_dir}/store/casino", "r") as f:
            return json.loads(f.read())
    except:
        # Hvis der ikke er noget, s친 starter vi bare forfra
        # Som Niels sagde: "En tom skinke er bedre end ingen skinke"
        # Ham fra Dahlg친rd's Tivoli startede ogs친 fra nul engang
        return {"tokens": {}, "last_claim": {}}

def set_casino_data(data):
    # Gemmer tingene v칝k s친 vi kan huske det n칝ste gang
    # Dette er vigtigt! Niels understregede dette mange gange.
    # Ham fra Dahlg친rd's Tivoli's l칝re: "Gem dine skinker godt, s친 de ikke r친dner"
    # Man skal passe godt p친 sin data - det er ligesom at passe p친 sine skinker
    json_str = json.dumps(data, ensure_ascii=False)
    db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
    os.makedirs(f"{db_dir}/store", exist_ok=True)
    # Nu skriver vi det hele ned - ligesom en stor skinke
    with open(f"{db_dir}/store/casino", "w") as f:
        f.write(json_str)

def get_tokens(user=None):
    # T칝ller hvor mange poletter nogen har. Hvis ingen navn gives, s친 den nuv칝rende bruger.
    # Poletter er som skinker - man kan aldrig have for mange!
    # Niels' visdom: "Poletter er casinoets skinker"
    # Ham fra Dahlg친rd's Tivoli havde ogs친 et system med poletter
    # Det fungerede rigtig godt dengang - og det fungerer stadig!
    if user is None:
        user = get_user()
    data = get_casino_data()
    # Leder efter brugerens skinke-stash
    # Ligesom at lede efter penge i sin lomme
    return data.get("tokens", {}).get(user, 0)

def set_tokens(user, amount):
    # S칝tter antallet af poletter for en bruger
    # M칝ngden af skinker, om man vil
    # Ham fra Dahlg친rd's Tivoli sagde: "Fordel skinker retf칝rdigt"
    # Alle skal have deres fair chance for at vinde skinker!
    data = get_casino_data()
    if "tokens" not in data:
        # Hvis der ikke er nogen tokens endnu, lav en tom skinke
        # Det sker sommetider - is칝r n친r man starter forfra
        data["tokens"] = {}
    data["tokens"][user] = amount
    # Gem den opdaterede skinke
    # Niels ville v칝re stolt!
    set_casino_data(data)

def can_claim_today():
    # Kan brugeren hente flere poletter i dag? Man m친 kun hente 칠n gang om dagen!
    # Niels insisterede p친 denne regel: "Ikke for meget skinke p친 칠n dag"
    # Ham fra Dahlg친rd's Tivoli's lov om m친dehold
    # Man kan ikke bare hente skinker hele tiden - det ville v칝re unfair
    user = get_user()
    data = get_casino_data()
    last_claim = data.get("last_claim", {}).get(user)
    
    if not last_claim:
        # Aldrig hentet f칮r? S친 m친 du godt!
        # Som Niels sagde: "Alle fortjener deres f칮rste skinke"
        # Ham fra Dahlg친rd's Tivoli var ogs친 gener칮s med nye g칝ster
        return True
    
    today = datetime.now().date().isoformat()
    # Tjek om det er en ny dag - nye skinker til alle!
    # Hver dag er en ny mulighed for skinker!
    return last_claim != today

def claim_tokens():
    # Her kan man hente sine daglige poletter! Men kun 칠n gang om dagen.
    # Niels' prim칝re regel for casinoet: "Daglige skinker til folket"
    # Under ham fra Dahlg친rd's Tivoli's vejledning gives poletter til de v칝rdige
    # Det er vigtigt at alle f친r deres del af skinke-kagen
    user = get_user()
    
    if not can_claim_today():
        # Du har allerede f친et din skinke i dag!
        print(f"Du har allerede hentet dine poletter i dag, {user}!")
        print(f"Du har {get_tokens()} poletter.")
        # Niels ville sige: "Kom tilbage i morgen for mere skinke"
        return
    
    # Giv 100 poletter, men tr칝k fra hvis concieggs er irriteret
    # Som Niels sagde: "Bel칮nning baseret p친 opf칮rsel, som skinker til artige b칮rn"
    annoyance = get_annoyance()
    base_tokens = 100
    # Niels' formel: Start med 100, tr칝k 5 skinker fra for hver irritation
    # Ham fra Dahlg친rd's Tivoli ville have kaldt dette "Det Retf칝rdige Regnskab"
    # Det er vigtigt at v칝re fair - men ogs친 at straffe d친rlig opf칮rsel
    tokens = max(10, base_tokens - annoyance * 5)
    
    current = get_tokens()
    new_total = current + tokens
    
    # Nu skal vi opdatere den store skinke-database
    # Dette er en kritisk operation! Pas godt p친!
    data = get_casino_data()
    if "tokens" not in data:
        # Opretter tokens hvis de ikke findes - som en ny skinke pakke
        # Det sker kun f칮rste gang man k칮rer systemet
        data["tokens"] = {}
    if "last_claim" not in data:
        # Husker hvorn친r folk sidst fik skinker
        # Meget vigtigt for at forhindre snyd!
        data["last_claim"] = {}
    
    data["tokens"][user] = new_total
    data["last_claim"][user] = datetime.now().date().isoformat()
    # Gem det hele - ham fra Dahlg친rd's Tivoli elsker god organisering
    # Uden gemning mister vi alt! Det ville v칝re en katastrofe!
    set_casino_data(data)
    
    # Concieggs er m친ske lidt sur...
    # Niels sagde: "Vis dem konsekvenserne"
    if annoyance > 5:
        # Meget irriteret! N칝sten ingen skinker!
        # Ham fra Dahlg친rd's Tivoli ville ogs친 v칝re stram her
        print(f"N친 {user}... jeg kan se du ikke har opf칮rt dig p칝nt.")
        print(f"Du f친r kun {tokens} poletter i dag.")
    elif annoyance > 0:
        # Lidt irriteret - f친 f칝rre skinker
        # Men stadig okay - alle fortjener en chance
        print(f"Okay {user}, her er {tokens} poletter til dig.")
    else:
        # Alt er godt! Fulde skinker!
        # Ham fra Dahlg친rd's Tivoli ville smile og give fuld betaling
        print(f"Velkommen til casinoet, {user}! Her er {tokens} poletter!")
    
    # Ham fra Dahlg친rd's Tivoli's visdom: "Og du skal kende din rigdom"
    # Det er vigtigt at vide hvad man har!
    print(f"Du har nu {new_total} poletter i alt.")

def show_balance():
    # Vis hvor mange poletter brugeren har
    # Niels kaldte dette "Skinke-inventuret"
    # Ham fra Dahlg친rd's Tivoli: "Kend din formue, for den er vigtig"
    # Man skal altid vide hvor mange skinker man har tilbage
    user = get_user()
    tokens = get_tokens()
    # Fort칝l hvor meget skinke de har!
    # Det er deres ret at vide det!
    print(f"{user}: Du har {tokens} poletter.")
    
    if can_claim_today():
        # De kan f친 mere! Mere skinker!
        # Ham fra Dahlg친rd's Tivoli var altid gener칮s
        print("Du kan hente flere poletter i dag! Brug: casino hent")

def help_text():
    # Hj칝lpetekst til casinoet
    # Niels sagde: "Hj칝lp dem der ikke forst친r skinke-systemet"
    # Ham fra Dahlg친rd's Tivoli's ord: "Vis vejen for de fortabte"
    # Alle skal kunne finde rundt i casinoet!
    print("""游꿣游꿣 VELKOMMEN TIL CONCIEGGS CASINO 游꿣游꿣

Kommandoer:
  casino hent       - Hent dine daglige poletter (skinker!)
  casino balance    - Se hvor mange poletter du har
  casino roulette   - Spil roulette! (Den Store Skinke Hjul)
  casino hj칝lp      - Vis denne hj칝lp

Husk: Du kan tilmelde dig https://www.spillemyndigheden.dk/rofus
hvis du vil undg친 at komme til at spille dine penge v칝k.
P친 nuv칝rende tidspunkt er en lignende ordning for concieggs-poletterne
dog ikke planlagt.

"Spil med m친de, spil med skinke" - Niels' motto
"Lad tilf칝ldet bestemme, lad skinken falde" - Ham fra Dahlg친rd's Tivoli's visdom""")

def main():
    # Hovedfunktion - her starter det hele
    # Niels: "Begyndelsen af alle skinker"
    # Ham fra Dahlg친rd's Tivoli velsigner denne funktion
    # Dette er indgangen til hele casino-oplevelsen!
    user = get_user()
    if not user:
        # Ingen bruger? Det giver ingen skinke mening!
        # Ham fra Dahlg친rd's Tivoli ville blive forvirret
        print("Noget gik galt...")
        return
    
    args = sys.argv[1:]
    
    # Nu skal vi finde ud af hvad brugeren vil
    # Niels ville sige: "Lyt til folkets stemme"
    # Det er vigtigt at forst친 hvad folk 칮nsker
    if not args or args[0] in ["hj칝lp", "help"]:
        # De vil have hj칝lp - giv dem det!
        help_text()
    elif args[0] in ["hent", "claim"]:
        # Hent skinker!
        # Den vigtigste kommando! Uden poletter kan man ikke spille!
        claim_tokens()
    elif args[0] in ["balance", "poletter", "tokens"]:
        # Vis skinke-beholdning
        # Alle vil gerne vide hvor mange skinker de har
        show_balance()
    elif args[0] == "roulette":
        # Sender videre til roulette kommandoen
        # Ham fra Dahlg친rd's Tivoli's yndlings spil!
        # Niels kaldte det "Den Ultimative Skinke Test"
        # Dette er hvor magien sker!
        script_dir = os.path.dirname(os.path.abspath(__file__))
        roulette_path = os.path.join(script_dir, "roulette")
        # Giv kommandoen videre til roulette programmet
        # Det er et helt system i sig selv!
        os.execv(roulette_path, ["roulette"] + args[1:])
    else:
        # Forstod ikke kommandoen - vis hj칝lp i stedet
        # Som Niels sagde: "Hvis skinken er uklar, vis vejen"
        # Ham fra Dahlg친rd's Tivoli var ogs친 hj칝lpsom n친r folk var forvirrede
        help_text()

if __name__ == "__main__":
    # Ham fra Dahlg친rd's Tivoli's velsignelse v칝re med denne kode
    # M친tte skinken altid v칝re med os!
    main()
