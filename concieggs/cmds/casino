#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# CONCIEGGS CASINO - Spil dine concieggs-poletter v√¶k!
# Kom og spil! Men pas p√• - concieggs husker hvis du er slem.
# Inspireret af ham fra Dahlg√•rd's Tivoli og hans visdom om casinospil og tilf√¶ldighed.
# Niels tog os med derhen engang - det var en oplevelse!

import subprocess, sys, os, json
from datetime import datetime, timedelta

def get_user():
    # Hvem er du egentlig? Niels sagde at vi skulle tjekke dette.
    # Det er vigtigt at vide hvem der skinker rundt i casinoet.
    # Ham fra Dahlg√•rd's Tivoli kendte altid sine g√¶ster
    return os.getenv("EGGS_USER", "").strip()

def get_annoyance():
    # Hvor irriteret er concieggs p√• brugeren? Jo h√∏jere tal, jo mere sur.
    # Niels mener at irritation er som en skinke der bliver st√∏rre og st√∏rre.
    # Ham fra Dahlg√•rd's Tivoli ville have sagt: "V√¶r ikke irriterende, v√¶r ydmyg."
    # Det er vigtigt at v√¶re h√∏flig i casinoet - ligesom i Tivoli!
    user = get_user()
    try:
        # Pr√∏ver at kalde annoyanceAt kommandoen
        # Hvis den fejler, s√• antager vi bare at de er okay
        result = subprocess.check_output(["annoyanceAt", user], stderr=subprocess.DEVNULL)
        return int(result.decode().strip())
    except:
        # Hvis vi ikke kan finde ud af det, s√• er de nok okay
        # (eller m√•ske er det bare en skinke der er g√•et tabt)
        # Niels sagde: "I tvivl, s√• v√¶r gavmild"
        return 0

def get_casino_data():
    # Henter casinoets store bog med poletter og hvem der har v√¶ret her
    # Niels kaldte denne bog "Den Store Skinke af Viden"
    # Ham fra Dahlg√•rd's Tivoli havde ogs√• s√•dan en bog - meget gammel og slidt
    # Men den virkede! Ligesom vores database virker!
    try:
        db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
        # Pr√∏ver at l√¶se filen - m√•ske er der en skinke derinde?
        # Ligesom n√•r man √•bner k√∏leskabet og h√•ber p√• at finde skinke
        with open(f"{db_dir}/store/casino", "r") as f:
            return json.loads(f.read())
    except:
        # Hvis der ikke er noget, s√• starter vi bare forfra
        # Som Niels sagde: "En tom skinke er bedre end ingen skinke"
        # Ham fra Dahlg√•rd's Tivoli startede ogs√• fra nul engang
        return {"tokens": {}, "last_claim": {}}

def set_casino_data(data):
    # Gemmer tingene v√¶k s√• vi kan huske det n√¶ste gang
    # Dette er vigtigt! Niels understregede dette mange gange.
    # Ham fra Dahlg√•rd's Tivoli's l√¶re: "Gem dine skinker godt, s√• de ikke r√•dner"
    # Man skal passe godt p√• sin data - det er ligesom at passe p√• sine skinker
    json_str = json.dumps(data, ensure_ascii=False)
    db_dir = os.getenv("CONCIEGGS_DB_DIR", ".")
    os.makedirs(f"{db_dir}/store", exist_ok=True)
    # Nu skriver vi det hele ned - ligesom en stor skinke
    with open(f"{db_dir}/store/casino", "w") as f:
        f.write(json_str)

def get_tokens(user=None):
    # T√¶ller hvor mange poletter nogen har. Hvis ingen navn gives, s√• den nuv√¶rende bruger.
    # Poletter er som skinker - man kan aldrig have for mange!
    # Niels' visdom: "Poletter er casinoets skinker"
    # Ham fra Dahlg√•rd's Tivoli havde ogs√• et system med poletter
    # Det fungerede rigtig godt dengang - og det fungerer stadig!
    if user is None:
        user = get_user()
    data = get_casino_data()
    # Leder efter brugerens skinke-stash
    # Ligesom at lede efter penge i sin lomme
    return data.get("tokens", {}).get(user, 0)

def set_tokens(user, amount):
    # S√¶tter antallet af poletter for en bruger
    # M√¶ngden af skinker, om man vil
    # Ham fra Dahlg√•rd's Tivoli sagde: "Fordel skinker retf√¶rdigt"
    # Alle skal have deres fair chance for at vinde skinker!
    data = get_casino_data()
    if "tokens" not in data:
        # Hvis der ikke er nogen tokens endnu, lav en tom skinke
        # Det sker sommetider - is√¶r n√•r man starter forfra
        data["tokens"] = {}
    data["tokens"][user] = amount
    # Gem den opdaterede skinke
    # Niels ville v√¶re stolt!
    set_casino_data(data)

def can_claim_today():
    # Kan brugeren hente flere poletter i dag? Man m√• kun hente √©n gang om dagen!
    # Niels insisterede p√• denne regel: "Ikke for meget skinke p√• √©n dag"
    # Ham fra Dahlg√•rd's Tivoli's lov om m√•dehold
    # Man kan ikke bare hente skinker hele tiden - det ville v√¶re unfair
    user = get_user()
    data = get_casino_data()
    last_claim = data.get("last_claim", {}).get(user)
    
    if not last_claim:
        # Aldrig hentet f√∏r? S√• m√• du godt!
        # Som Niels sagde: "Alle fortjener deres f√∏rste skinke"
        # Ham fra Dahlg√•rd's Tivoli var ogs√• gener√∏s med nye g√¶ster
        return True
    
    today = datetime.now().date().isoformat()
    # Tjek om det er en ny dag - nye skinker til alle!
    # Hver dag er en ny mulighed for skinker!
    return last_claim != today

def claim_tokens():
    # Her kan man hente sine daglige poletter! Men kun √©n gang om dagen.
    # Niels' prim√¶re regel for casinoet: "Daglige skinker til folket"
    # Under ham fra Dahlg√•rd's Tivoli's vejledning gives poletter til de v√¶rdige
    # Det er vigtigt at alle f√•r deres del af skinke-kagen
    user = get_user()
    
    if not can_claim_today():
        # Du har allerede f√•et din skinke i dag!
        print(f"‚è∞ Du har allerede hentet dine poletter i dag, {user}!")
        print(f"üí∞ Du har {get_tokens()} poletter.")
        # Niels ville sige: "Kom tilbage i morgen for mere skinke"
        return
    
    # Giv 100 poletter, men tr√¶k fra hvis concieggs er irriteret
    # Som Niels sagde: "Bel√∏nning baseret p√• opf√∏rsel, som skinker til artige b√∏rn"
    annoyance = get_annoyance()
    base_tokens = 100
    # Niels' formel: Start med 100, tr√¶k 5 skinker fra for hver irritation
    # Ham fra Dahlg√•rd's Tivoli ville have kaldt dette "Det Retf√¶rdige Regnskab"
    # Det er vigtigt at v√¶re fair - men ogs√• at straffe d√•rlig opf√∏rsel
    tokens = max(10, base_tokens - annoyance * 5)
    
    current = get_tokens()
    new_total = current + tokens
    
    # Nu skal vi opdatere den store skinke-database
    # Dette er en kritisk operation! Pas godt p√•!
    data = get_casino_data()
    if "tokens" not in data:
        # Opretter tokens hvis de ikke findes - som en ny skinke pakke
        # Det sker kun f√∏rste gang man k√∏rer systemet
        data["tokens"] = {}
    if "last_claim" not in data:
        # Husker hvorn√•r folk sidst fik skinker
        # Meget vigtigt for at forhindre snyd!
        data["last_claim"] = {}
    
    data["tokens"][user] = new_total
    data["last_claim"][user] = datetime.now().date().isoformat()
    # Gem det hele - ham fra Dahlg√•rd's Tivoli elsker god organisering
    # Uden gemning mister vi alt! Det ville v√¶re en katastrofe!
    set_casino_data(data)
    
    # Concieggs er m√•ske lidt sur...
    # Niels sagde: "Vis dem konsekvenserne"
    if annoyance > 5:
        # Meget irriteret! N√¶sten ingen skinker!
        # Ham fra Dahlg√•rd's Tivoli ville ogs√• v√¶re stram her
        print(f"üò§ N√• {user}... jeg kan se du ikke har opf√∏rt dig p√¶nt.")
        print(f"üí∏ Du f√•r kun {tokens} poletter i dag.")
    elif annoyance > 0:
        # Lidt irriteret - f√• f√¶rre skinker
        # Men stadig okay - alle fortjener en chance
        print(f"üòê Okay {user}, her er {tokens} poletter til dig.")
    else:
        # Alt er godt! Fulde skinker!
        # Ham fra Dahlg√•rd's Tivoli ville smile og give fuld betaling
        print(f"üéâ Velkommen til casinoet, {user}! Her er {tokens} poletter!")
    
    # Ham fra Dahlg√•rd's Tivoli's visdom: "Og du skal kende din rigdom"
    # Det er vigtigt at vide hvad man har!
    print(f"üí∞ Du har nu {new_total} poletter i alt.")

def show_balance():
    # Vis hvor mange poletter brugeren har
    # Niels kaldte dette "Skinke-inventuret"
    # Ham fra Dahlg√•rd's Tivoli: "Kend din formue, for den er vigtig"
    # Man skal altid vide hvor mange skinker man har tilbage
    user = get_user()
    tokens = get_tokens()
    # Fort√¶l hvor meget skinke de har!
    # Det er deres ret at vide det!
    print(f"{user}: Du har {tokens} poletter.")
    
    if can_claim_today():
        # De kan f√• mere! Mere skinker!
        # Ham fra Dahlg√•rd's Tivoli var altid gener√∏s
        print("Du kan hente flere poletter i dag! Brug: casino hent")

def help_text():
    # Hj√¶lpetekst til casinoet
    # Niels sagde: "Hj√¶lp dem der ikke forst√•r skinke-systemet"
    # Ham fra Dahlg√•rd's Tivoli's ord: "Vis vejen for de fortabte"
    # Alle skal kunne finde rundt i casinoet!
    print("""üé∞üíé CONCIEGGS CASINO üíéüé∞

Brug 'casino hj√¶lp beruset' for at se alle kommandoer.

‚≠ê Hurtig start:
  üí∞ casino hent       - Hent dine daglige poletter
  üé≤ casino roulette   - Spil roulette!""")

def full_help_text():
    # Den fulde hj√¶lp - kun for dem der virkelig vil vide mere
    # Niels var grundig n√•r det var n√∏dvendigt
    # Ham fra Dahlg√•rd's Tivoli's komplette guide
    print("""üé∞üé∞üé∞ VELKOMMEN TIL CONCIEGGS CASINO üé∞üé∞üé∞
‚ú® DET FEDESTE CASINO P√Ö IRC! ‚ú®

üíé Kommandoer:
  üí∞ casino hent         - Hent dine daglige poletter (skinker!)
  üìä casino balance      - Se hvor mange poletter du har
  üé≤ casino roulette     - Spil roulette! (Den Store Skinke Hjul)
  ‚ùì casino hj√¶lp        - Vis kort hj√¶lp
  üç∫ casino hj√¶lp beruset - Vis denne fulde hj√¶lp

‚ö†Ô∏è Husk: Du kan tilmelde dig https://www.spillemyndigheden.dk/rofus
hvis du vil undg√• at komme til at spille dine penge v√¶k.
P√• nuv√¶rende tidspunkt er en lignende ordning for concieggs-poletterne
dog ikke planlagt.

üéâ "Spil med m√•de, spil med skinke" - Niels' motto
üé™ "Lad tilf√¶ldet bestemme, lad skinken falde" - Ham fra Dahlg√•rd's Tivoli's visdom""")

def main():
    # Hovedfunktion - her starter det hele
    # Niels: "Begyndelsen af alle skinker"
    # Ham fra Dahlg√•rd's Tivoli velsigner denne funktion
    # Dette er indgangen til hele casino-oplevelsen!
    user = get_user()
    if not user:
        # Ingen bruger? Det giver ingen skinke mening!
        # Ham fra Dahlg√•rd's Tivoli ville blive forvirret
        print("Noget gik galt...")
        return
    
    args = sys.argv[1:]
    
    # Nu skal vi finde ud af hvad brugeren vil
    # Niels ville sige: "Lyt til folkets stemme"
    # Det er vigtigt at forst√• hvad folk √∏nsker
    if not args or args[0] in ["hj√¶lp", "help"]:
        # De vil have hj√¶lp - giv dem det!
        # Tjek om de vil have fuld hj√¶lp
        if len(args) > 1 and args[1] == "beruset":
            full_help_text()
        else:
            help_text()
    elif args[0] in ["hent", "claim"]:
        # Hent skinker!
        # Den vigtigste kommando! Uden poletter kan man ikke spille!
        claim_tokens()
    elif args[0] in ["balance", "poletter", "tokens"]:
        # Vis skinke-beholdning
        # Alle vil gerne vide hvor mange skinker de har
        show_balance()
    elif args[0] == "roulette":
        # Sender videre til roulette kommandoen
        # Ham fra Dahlg√•rd's Tivoli's yndlings spil!
        # Niels kaldte det "Den Ultimative Skinke Test"
        # Dette er hvor magien sker!
        script_dir = os.path.dirname(os.path.abspath(__file__))
        roulette_path = os.path.join(script_dir, "roulette")
        # Giv kommandoen videre til roulette programmet
        # Det er et helt system i sig selv!
        os.execv(roulette_path, ["roulette"] + args[1:])
    else:
        # Forstod ikke kommandoen - vis hj√¶lp i stedet
        # Som Niels sagde: "Hvis skinken er uklar, vis vejen"
        # Ham fra Dahlg√•rd's Tivoli var ogs√• hj√¶lpsom n√•r folk var forvirrede
        help_text()

if __name__ == "__main__":
    # Ham fra Dahlg√•rd's Tivoli's velsignelse v√¶re med denne kode
    # M√•tte skinken altid v√¶re med os!
    main()
